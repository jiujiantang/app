#!/usr/bin/env node
"use strict";const i=require("fs/promises"),a=process.env.OPENAI_API_KEY||"",A=process.env.OPENAI_BASE||"https://api.openai.com/v1",l=process.env.API2D_KEY||"",m=process.env.API2D_BASE||"https://openai.api2d.net/v1";!a&&!l&&(console.error("âŒ è¯·è®¾ç½® OPENAI_API_KEY æˆ– API2D_KEY ç¯å¢ƒå˜é‡"),process.exit(1));const E="gpt-4o-mini";async function P(e){return i.readFile(`prompts/${e}.md`,"utf8")}async function u(e,t,s){const n=await fetch(`${e}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({model:E,messages:[{role:"system",content:"ä½ æ˜¯ä¸€ä¸ªå‰ç«¯å·¥ç¨‹å¸ˆï¼Œè¾“å‡º Vue/React ç»„ä»¶ã€stories å’Œæµ‹è¯•æ–‡ä»¶ä»£ç ã€‚"},{role:"user",content:s}],temperature:0,max_tokens:3e3})});if(!n.ok){const r=await n.text();throw new Error(`${e} è¿”å›é”™è¯¯: ${n.status} ${r}`)}return(await n.json()).choices?.[0]?.message?.content}async function d(e){try{if(a)return console.log("ğŸŒ æ­£åœ¨è°ƒç”¨ OpenAI..."),await u(A,a,e);throw new Error("æœªè®¾ç½® OPENAI_API_KEY")}catch(t){if(console.warn("âš ï¸ OpenAI è°ƒç”¨å¤±è´¥:",t.message),l)return console.log("ğŸ”„ åˆ‡æ¢åˆ° API2D..."),await u(m,l,e);throw new Error("æ²¡æœ‰å¯ç”¨çš„ API2D_KEYï¼Œæ— æ³•å›é€€")}}function w(e,t){const s={},n=/```(?:\w+)?\n([\s\S]*?)```/g;let c,r=0;for(;(c=n.exec(e))!==null;){const o=c[1].trim();o.includes("stories")?s[`${t}.stories.ts`]=o:o.includes("spec")?s[`${t}.spec.ts`]=o:o.includes("typescriptTypes")?s[`${t}.type.ts`]=o:s[`${t}.tsx`]=o,r++}return r===0&&(s[`${t}.tsx`]=e),s}async function I(){const[,,e,t]=process.argv;if(e!=="generate"||!t){console.log("ç”¨æ³•: node ai-agent.js generate <promptName>");return}const s=await P(t),n=s;console.log("è°ƒç”¨æ¨¡å‹...");const c=await d(n),r=w(c,t);await i.mkdir("src",{recursive:!0});for(const[o,f]of Object.entries(r)){const p=`src/${o}`;await i.writeFile(p,f,"utf8"),console.log("âœ… å·²å†™å…¥ï¼š",p)}}I().catch(e=>{console.error("âŒ è¿è¡Œå‡ºé”™:",e),process.exit(1)});
