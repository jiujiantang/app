#!/usr/bin/env node
"use strict";const i=require("fs/promises"),a=process.env.OPENAI_API_KEY||"",A=process.env.OPENAI_BASE||"https://api.openai.com/v1",l=process.env.API2D_KEY||"",m=process.env.API2D_BASE||"https://openai.api2d.net/v1";!a&&!l&&(console.error("❌ 请设置 OPENAI_API_KEY 或 API2D_KEY 环境变量"),process.exit(1));const E="gpt-4o-mini";async function P(e){return i.readFile(`prompts/${e}.md`,"utf8")}async function u(e,t,s){const n=await fetch(`${e}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({model:E,messages:[{role:"system",content:"你是一个前端工程师，输出 Vue/React 组件、stories 和测试文件代码。"},{role:"user",content:s}],temperature:0,max_tokens:3e3})});if(!n.ok){const r=await n.text();throw new Error(`${e} 返回错误: ${n.status} ${r}`)}return(await n.json()).choices?.[0]?.message?.content}async function d(e){try{if(a)return console.log("🌐 正在调用 OpenAI..."),await u(A,a,e);throw new Error("未设置 OPENAI_API_KEY")}catch(t){if(console.warn("⚠️ OpenAI 调用失败:",t.message),l)return console.log("🔄 切换到 API2D..."),await u(m,l,e);throw new Error("没有可用的 API2D_KEY，无法回退")}}function w(e,t){const s={},n=/```(?:\w+)?\n([\s\S]*?)```/g;let c,r=0;for(;(c=n.exec(e))!==null;){const o=c[1].trim();o.includes("stories")?s[`${t}.stories.ts`]=o:o.includes("spec")?s[`${t}.spec.ts`]=o:o.includes("typescriptTypes")?s[`${t}.type.ts`]=o:s[`${t}.tsx`]=o,r++}return r===0&&(s[`${t}.tsx`]=e),s}async function I(){const[,,e,t]=process.argv;if(e!=="generate"||!t){console.log("用法: node ai-agent.js generate <promptName>");return}const s=await P(t),n=s;console.log("调用模型...");const c=await d(n),r=w(c,t);await i.mkdir("src",{recursive:!0});for(const[o,f]of Object.entries(r)){const p=`src/${o}`;await i.writeFile(p,f,"utf8"),console.log("✅ 已写入：",p)}}I().catch(e=>{console.error("❌ 运行出错:",e),process.exit(1)});
